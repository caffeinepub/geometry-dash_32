import {
  TILE_SIZE,
  PRACTICE_CHECKPOINT_COUNT,
  CHECKPOINT_SAFE_RADIUS,
} from "./constants";

export type GameMode = "cube" | "ship" | "ball";

export interface Obstacle {
  type: "block" | "spike" | "platform";
  x: number;
  y: number;
  width: number;
  height: number;
}

export interface GroundSegment {
  start: number;
  end: number;
}

export interface Portal {
  x: number;
  targetMode: GameMode;
}

export interface LevelData {
  id: number;
  name: string;
  difficulty: "easy" | "medium" | "hard" | "sample";
  bpm: number;
  musicFile: string;
  totalLength: number;
  startMode: GameMode;
  groundSegments: GroundSegment[];
  obstacles: Obstacle[];
  portals: Portal[];
  backgroundColor: string;
  accentColor: string;
  sample?: boolean;
}

const T = TILE_SIZE;

function ground(startTile: number, endTile: number): GroundSegment {
  return { start: startTile * T, end: endTile * T };
}

function spike(tile: number, yTile = 0): Obstacle {
  return { type: "spike", x: tile * T, y: yTile * T, width: T, height: T };
}

function block(tile: number, yTile = 0, wTiles = 1, hTiles = 1): Obstacle {
  return {
    type: "block",
    x: tile * T,
    y: yTile * T,
    width: wTiles * T,
    height: hTiles * T,
  };
}

// Sample Level: Test Drive (~35 seconds)
// Showcases all three modes: cube → ship → ball → cube
const sampleLevel: LevelData = {
  id: 0,
  name: "Test Drive",
  difficulty: "sample",
  bpm: 112.3,
  musicFile: "newer-wave.opus",
  totalLength: 340 * T,
  startMode: "cube",
  sample: true,
  portals: [
    { x: 90 * T, targetMode: "ship" },
    { x: 180 * T, targetMode: "ball" },
    { x: 270 * T, targetMode: "cube" },
  ],
  groundSegments: [ground(0, 50), ground(52, 340)],
  obstacles: [
    // Cube section 1 (tiles 0-90): intro jumps and gaps
    spike(12),
    spike(22),
    spike(23),
    block(32, 0, 1, 1),
    spike(40),
    spike(41),
    spike(55),
    block(63, 0, 1, 1),
    spike(72),
    spike(73),
    spike(74),
    spike(84),

    // Ship section (tiles 90-180): fly through gaps between blocks
    block(105, 0, 2, 3),
    spike(115, 2),
    block(125, 3, 2, 3),
    spike(135),
    block(140, 0, 2, 4),
    spike(150, 3),
    block(155, 3, 2, 3),
    block(162, 0, 2, 3),
    spike(170, 2),
    block(175, 2, 2, 3),

    // Ball section (tiles 180-270): gravity flips past obstacles
    spike(195),
    block(200, 0, 1, 1),
    spike(210, 3),
    block(215, 3, 2, 3),
    spike(225),
    spike(230),
    block(238, 0, 2, 3),
    spike(248, 3),
    block(253, 2, 2, 3),
    spike(263),

    // Cube section 2 (tiles 270-340): final stretch
    spike(285),
    spike(289),
    block(296, 0, 1, 1),
    spike(305),
    spike(306),
    spike(315),
    block(322, 0, 1, 1),
    spike(330),
  ],
  backgroundColor: "#0a1a20",
  accentColor: "#88ccff",
};

// Level 1: Stereo Madness (easy) - 112.3 BPM
// Music: newer-wave.opus
const level1: LevelData = {
  id: 1,
  name: "Stereo Madness",
  difficulty: "easy",
  bpm: 112.3,
  musicFile: "newer-wave.opus",
  totalLength: 1581 * T,
  startMode: "cube",
  portals: [],
  groundSegments: [
    ground(0, 316),
    ground(318, 632),
    ground(634, 953),
    ground(955, 1264),
    ground(1266, 1581),
  ],
  obstacles: [
    spike(35),
    spike(59),
    spike(69),
    spike(79),
    spike(89),
    spike(99),
    spike(113),
    block(123, 0, 1, 1),
    spike(192),
    spike(197),
    spike(202),
    spike(207),
    spike(231),
    spike(251),
    block(295, 0, 1, 1),
    spike(305),
    spike(310),
    spike(344),
    spike(349),
    spike(354),
    spike(369),
    block(378, 0, 1, 1),
    spike(403),
    spike(428),
    spike(442),
    spike(472),
    spike(506),
    spike(526),
    spike(555),
    spike(565),
    spike(585),
    spike(595),
    spike(604),
    spike(614),
    spike(639),
    spike(644),
    spike(653),
    spike(658),
    spike(668),
    spike(678),
    spike(683),
    block(688, 0, 1, 1),
    block(717, 0, 1, 1),
    spike(751),
    spike(766),
    spike(771),
    spike(781),
    spike(786),
    spike(806),
    spike(830),
    spike(845),
    spike(855),
    spike(889),
    spike(914),
    spike(928),
    spike(938),
    block(948, 0, 1, 1),
    spike(958),
    spike(987),
    spike(1007),
    spike(1017),
    spike(1032),
    spike(1036),
    spike(1061),
    spike(1085),
    block(1105, 0, 1, 1),
    spike(1120),
    spike(1130),
    spike(1154),
    spike(1164),
    spike(1174),
    block(1188, 0, 1, 1),
    block(1218, 0, 1, 1),
    spike(1247),
    spike(1252),
    spike(1277),
    spike(1302),
    spike(1331),
    spike(1351),
    spike(1360),
    spike(1370),
    spike(1375),
    spike(1390),
    spike(1414),
    block(1429, 0, 1, 1),
    spike(1444),
    spike(1454),
    spike(1468),
    block(1493, 0, 1, 1),
    spike(1503),
  ],
  backgroundColor: "#0a1628",
  accentColor: "#00ff88",
};

// Level 2: Back On Track (medium) - 136.0 BPM
// Music: raving-energy.opus
const level2: LevelData = {
  id: 2,
  name: "Back On Track",
  difficulty: "medium",
  bpm: 136.0,
  musicFile: "raving-energy.opus",
  totalLength: 2203 * T,
  startMode: "ship",
  portals: [
    { x: 610 * T, targetMode: "cube" },
    { x: 1200 * T, targetMode: "ship" },
    { x: 1550 * T, targetMode: "cube" },
  ],
  groundSegments: [ground(0, 2203)],
  obstacles: [
    spike(19),
    spike(23),
    block(31, 0, 1, 1),
    // Ship section 1: elevated obstacles (tiles 0-610)
    block(39, 0, 2, 3),
    spike(47, 2),
    spike(59),
    spike(63),
    spike(71),
    block(79, 3, 2, 3),
    spike(99),
    spike(107, 3),
    block(111, 0, 2, 3),
    spike(115),
    spike(124),
    block(140, 3, 2, 3),
    spike(160, 2),
    block(168, 0, 2, 4),
    spike(180),
    block(188, 3, 2, 3),
    block(200, 0, 1, 1),
    block(220, 2, 2, 3),
    block(248, 0, 2, 3),
    spike(256, 2),
    spike(261),
    block(269, 3, 2, 3),
    block(277, 0, 1, 1),
    spike(289),
    spike(293),
    spike(297),
    block(301, 0, 2, 4),
    spike(305),
    spike(309),
    spike(316),
    block(323, 3, 2, 3),
    spike(331, 3),
    block(339, 0, 2, 3),
    spike(347),
    spike(351),
    block(359, 3, 2, 3),
    spike(379, 2),
    block(383, 2, 2, 3),
    block(408, 0, 2, 4),
    spike(428),
    spike(436),
    spike(440),
    block(444, 3, 2, 3),
    spike(448),
    block(460, 0, 2, 3),
    spike(476, 3),
    block(480, 3, 2, 3),
    spike(484),
    spike(492),
    spike(496),
    spike(504),
    block(508, 0, 2, 4),
    spike(520),
    spike(525),
    block(529, 3, 2, 3),
    spike(541),
    spike(545),
    block(549, 2, 2, 3),
    spike(569, 2),
    block(573, 0, 2, 3),
    spike(577),
    block(589, 3, 2, 3),
    spike(601),
    spike(609),
    // Cube section 1: ground obstacles (tiles 610-1200)
    spike(629),
    spike(633, 1),
    spike(637),
    spike(641, 1),
    spike(674),
    spike(678, 1),
    spike(682),
    spike(698, 1),
    spike(710),
    spike(714, 1),
    spike(734),
    spike(738, 1),
    spike(746),
    spike(758),
    spike(762, 1),
    spike(766),
    spike(778),
    spike(786, 1),
    spike(795, 1),
    spike(815),
    spike(843),
    spike(847, 1),
    block(855, 0, 1, 2),
    spike(867, 1),
    block(891, 0, 1, 2),
    spike(899),
    spike(911, 1),
    spike(919),
    spike(923, 1),
    spike(927),
    spike(940, 1),
    spike(960, 1),
    block(976, 0, 1, 2),
    block(984, 0, 1, 2),
    spike(996, 1),
    spike(1000, 1),
    spike(1008),
    spike(1012, 1),
    block(1028, 0, 1, 2),
    spike(1040),
    spike(1044, 1),
    spike(1048),
    block(1060, 0, 1, 2),
    spike(1069, 1),
    spike(1072, 1),
    spike(1076, 1),
    spike(1093),
    spike(1097, 1),
    spike(1109),
    spike(1125, 1),
    spike(1133, 1),
    spike(1153),
    spike(1157, 1),
    spike(1161, 1),
    spike(1173),
    spike(1181, 1),
    spike(1185),
    spike(1201),
    // Ship section 2: elevated obstacles (tiles 1200-1550)
    block(1206, 0, 2, 3),
    spike(1210, 2),
    block(1214, 3, 2, 3),
    block(1222, 0, 1, 1),
    block(1230, 0, 2, 4),
    spike(1234),
    block(1242, 3, 2, 3),
    spike(1246),
    spike(1250),
    spike(1254),
    block(1258, 2, 2, 3),
    spike(1262),
    block(1270, 0, 1, 1),
    block(1278, 3, 2, 3),
    spike(1286),
    block(1290, 0, 2, 4),
    spike(1294, 3),
    block(1306, 3, 2, 3),
    spike(1318),
    block(1326, 0, 2, 3),
    block(1335, 3, 2, 3),
    spike(1339),
    spike(1342),
    block(1346, 2, 2, 3),
    spike(1355),
    block(1363, 0, 2, 4),
    spike(1371),
    spike(1375),
    block(1379, 3, 2, 3),
    spike(1387),
    block(1395, 0, 2, 3),
    block(1403, 3, 2, 3),
    spike(1407, 2),
    block(1419, 0, 1, 2),
    block(1427, 0, 1, 1),
    block(1435, 3, 2, 3),
    block(1439, 0, 1, 2),
    spike(1447),
    block(1451, 2, 2, 3),
    block(1459, 0, 1, 1),
    block(1463, 3, 2, 3),
    spike(1471, 3),
    spike(1476),
    block(1480, 0, 2, 4),
    block(1488, 0, 1, 2),
    block(1492, 3, 2, 3),
    spike(1496),
    spike(1500),
    block(1504, 0, 2, 3),
    block(1512, 3, 2, 3),
    spike(1516),
    spike(1520),
    spike(1524),
    spike(1528),
    spike(1532),
    block(1536, 2, 2, 3),
    spike(1540, 2),
    block(1544, 0, 2, 3),
    spike(1548),
    block(1552, 3, 2, 3),
    spike(1556),
    // Cube section 2: ground obstacles (tiles 1550-2203)
    spike(1560),
    spike(1572, 1),
    spike(1580),
    spike(1584, 1),
    spike(1588),
    spike(1596, 1),
    spike(1604),
    spike(1609, 1),
    spike(1616),
    spike(1621, 1),
    spike(1625),
    block(1637, 0, 1, 2),
    spike(1669, 1),
    spike(1677, 1),
    spike(1681, 1),
    block(1693, 0, 1, 2),
    spike(1701, 1),
    spike(1713),
    spike(1717, 1),
    block(1721, 0, 1, 2),
    spike(1729, 1),
    spike(1737),
    spike(1750, 1),
    block(1758, 0, 1, 2),
    spike(1782),
    spike(1790, 1),
    spike(1814),
    spike(1818, 1),
    block(1834, 0, 1, 2),
    spike(1842),
    spike(1854, 1),
    spike(1866),
    spike(1882, 1),
    block(1891, 0, 1, 1),
    spike(1903, 1),
    spike(1911),
    spike(1915, 1),
    spike(1923),
    spike(1931, 1),
    spike(1935),
    spike(1947),
    spike(1951, 1),
    spike(1959),
    spike(1963, 1),
    spike(1971),
    spike(1987),
    spike(1999, 1),
    spike(2007),
    spike(2020),
    spike(2024, 1),
    spike(2028),
    spike(2031, 1),
    block(2040, 0, 1, 2),
    block(2052, 0, 1, 2),
    spike(2076, 1),
    block(2092, 0, 1, 2),
    block(2100, 0, 1, 2),
    spike(2108, 1),
    spike(2120, 1),
  ],
  backgroundColor: "#1a0a28",
  accentColor: "#00bfff",
};

// Level 3: Polargeist (hard) - 143.6 BPM
// Music: bleeping-demo.opus
const level3: LevelData = {
  id: 3,
  name: "Polargeist",
  difficulty: "hard",
  bpm: 143.6,
  musicFile: "bleeping-demo.opus",
  totalLength: 1934 * T,
  startMode: "ball",
  portals: [
    { x: 620 * T, targetMode: "cube" },
    { x: 1100 * T, targetMode: "ball" },
    { x: 1270 * T, targetMode: "cube" },
  ],
  groundSegments: [ground(0, 1934)],
  obstacles: [
    spike(27),
    // Ball section 1: elevated obstacles (tiles 0-620)
    block(34, 2, 2, 3),
    spike(48, 2),
    spike(52),
    spike(56),
    spike(60),
    block(63, 3, 2, 3),
    block(74, 0, 1, 1),
    spike(78),
    block(85, 2, 2, 3),
    spike(97),
    spike(101),
    spike(104),
    block(108, 0, 2, 3),
    block(119, 3, 2, 3),
    spike(126, 3),
    spike(130),
    block(134, 0, 1, 2),
    block(145, 2, 2, 3),
    block(159, 3, 2, 3),
    spike(171, 2),
    block(174, 0, 2, 3),
    spike(178),
    spike(182),
    spike(185),
    spike(189),
    spike(193),
    block(196, 2, 2, 3),
    spike(200),
    spike(204),
    spike(208),
    spike(211),
    block(215, 3, 2, 3),
    spike(219),
    spike(222),
    block(226, 0, 2, 3),
    block(233, 0, 1, 1),
    block(237, 2, 2, 3),
    block(241, 0, 1, 1),
    block(248, 3, 2, 3),
    spike(256),
    block(263, 0, 2, 3),
    spike(267, 3),
    block(270, 2, 2, 3),
    spike(278),
    spike(281),
    spike(285),
    spike(289),
    block(293, 3, 2, 3),
    spike(296),
    spike(300),
    spike(304),
    spike(307),
    block(311, 0, 2, 3),
    spike(315),
    spike(319),
    block(322, 2, 2, 3),
    spike(326),
    block(330, 0, 1, 1),
    block(333, 3, 2, 3),
    block(344, 0, 1, 1),
    spike(352, 2),
    block(359, 0, 2, 3),
    spike(363),
    spike(367),
    block(370, 2, 2, 3),
    spike(374),
    spike(378),
    block(381, 3, 2, 3),
    spike(385),
    spike(389),
    block(393, 0, 2, 3),
    spike(396),
    spike(400),
    block(404, 2, 2, 3),
    block(407, 0, 1, 1),
    spike(411, 3),
    block(415, 3, 2, 3),
    spike(422),
    block(429, 0, 2, 3),
    spike(437),
    block(444, 2, 2, 3),
    block(452, 3, 2, 3),
    block(459, 0, 1, 1),
    block(467, 0, 2, 3),
    block(474, 0, 1, 1),
    block(478, 0, 1, 1),
    block(485, 2, 2, 3),
    block(496, 3, 2, 3),
    spike(500, 2),
    block(503, 0, 2, 3),
    spike(511),
    spike(518),
    spike(522),
    block(526, 2, 2, 3),
    block(529, 0, 1, 1),
    spike(533),
    block(537, 3, 2, 3),
    spike(540),
    block(544, 0, 2, 3),
    spike(551, 3),
    spike(555),
    block(559, 2, 2, 3),
    spike(563),
    spike(570),
    block(574, 3, 2, 3),
    spike(577),
    spike(581),
    spike(585),
    block(588, 0, 2, 3),
    block(592, 0, 1, 2),
    spike(596),
    spike(600),
    block(603, 2, 2, 3),
    spike(607),
    block(611, 3, 2, 3),
    spike(615),
    spike(618),
    // Cube section 1: ground obstacles (tiles 620-1100)
    spike(637),
    spike(644),
    spike(648, 1),
    spike(651),
    spike(655, 1),
    spike(659),
    spike(663, 1),
    spike(666, 1),
    spike(681),
    spike(685, 1),
    spike(688),
    spike(692, 1),
    spike(707),
    spike(711, 1),
    spike(718),
    spike(722, 1),
    spike(729),
    spike(733, 1),
    spike(744),
    spike(751),
    spike(755, 1),
    spike(759, 1),
    spike(770),
    spike(773, 1),
    spike(777),
    spike(785, 1),
    spike(792),
    spike(796, 1),
    spike(803),
    spike(807),
    spike(810, 1),
    block(814, 0, 1, 2),
    spike(818),
    spike(822, 1),
    spike(825),
    spike(829, 1),
    spike(833),
    spike(836),
    spike(840, 1),
    spike(847),
    spike(855),
    spike(858, 1),
    spike(862),
    spike(866, 1),
    spike(877),
    spike(881, 1),
    spike(884),
    spike(888, 1),
    spike(895),
    spike(899, 1),
    block(914, 0, 1, 2),
    spike(918),
    spike(921, 1),
    spike(925),
    spike(929, 1),
    spike(944),
    spike(947, 1),
    block(955, 0, 1, 2),
    block(977, 0, 1, 2),
    spike(981, 1),
    spike(992, 1),
    spike(995),
    spike(999, 1),
    spike(1006),
    spike(1010, 1),
    spike(1014),
    spike(1021),
    spike(1025, 1),
    block(1032, 0, 1, 2),
    spike(1036),
    spike(1040, 1),
    spike(1044),
    spike(1047),
    spike(1051, 1),
    spike(1066),
    spike(1073, 1),
    spike(1077),
    spike(1084, 1),
    spike(1092),
    spike(1095, 1),
    spike(1103),
    // Ball section 2: elevated obstacles (tiles 1100-1270)
    block(1107, 2, 2, 3),
    spike(1110, 2),
    block(1114, 3, 2, 3),
    spike(1118),
    spike(1121),
    block(1125, 0, 2, 3),
    block(1128, 2, 2, 3),
    spike(1132),
    spike(1136),
    block(1140, 3, 2, 3),
    spike(1147, 3),
    block(1151, 0, 2, 3),
    block(1154, 0, 1, 2),
    spike(1158),
    spike(1162),
    block(1166, 2, 2, 3),
    block(1173, 3, 2, 3),
    spike(1177, 2),
    block(1180, 0, 2, 3),
    spike(1184),
    spike(1188),
    block(1191, 2, 2, 3),
    block(1195, 0, 1, 2),
    spike(1199),
    spike(1202),
    block(1206, 3, 2, 3),
    spike(1210, 3),
    block(1214, 0, 2, 3),
    spike(1217),
    block(1221, 2, 2, 3),
    spike(1225),
    spike(1228),
    spike(1232),
    block(1236, 3, 2, 3),
    spike(1240, 2),
    block(1243, 0, 2, 3),
    block(1247, 2, 2, 3),
    block(1251, 3, 2, 3),
    spike(1255),
    spike(1258),
    block(1262, 0, 2, 3),
    spike(1265, 3),
    block(1269, 2, 2, 3),
    spike(1273),
    spike(1276),
    // Cube section 2: ground obstacles (tiles 1270-1934)
    spike(1284),
    spike(1288, 1),
    spike(1291),
    spike(1295, 1),
    spike(1299),
    spike(1306),
    spike(1310, 1),
    spike(1314, 1),
    spike(1317),
    spike(1321),
    spike(1325, 1),
    spike(1328),
    spike(1332, 1),
    spike(1336),
    spike(1339, 1),
    spike(1343),
    spike(1347, 1),
    spike(1354),
    spike(1358, 1),
    spike(1365),
    spike(1369, 1),
    spike(1373),
    spike(1376, 1),
    spike(1380),
    block(1384, 0, 1, 2),
    spike(1395, 1),
    spike(1402),
    spike(1406, 1),
    block(1410, 0, 1, 2),
    spike(1413),
    spike(1417, 1),
    spike(1421, 1),
    block(1425, 0, 1, 2),
    spike(1432),
    spike(1436, 1),
    spike(1443),
    spike(1447, 1),
    spike(1450),
    spike(1454, 1),
    spike(1458),
    spike(1461, 1),
    spike(1465),
    spike(1469),
    spike(1472, 1),
    spike(1476),
    block(1480, 0, 1, 2),
    spike(1484, 1),
    spike(1487),
    spike(1491, 1),
    spike(1495),
    spike(1498),
    spike(1502, 1),
    spike(1506),
    spike(1509),
    spike(1513, 1),
    spike(1517),
    spike(1521),
    spike(1524, 1),
    spike(1528),
    block(1532, 0, 1, 2),
    spike(1535, 1),
    spike(1539, 1),
    spike(1543),
    spike(1547, 1),
    spike(1554),
    spike(1565),
    spike(1569, 1),
    spike(1573, 1),
    spike(1580),
    block(1591, 0, 1, 2),
    spike(1595, 1),
    spike(1609),
    spike(1613, 1),
    spike(1617, 1),
    spike(1621),
    spike(1624),
    spike(1628, 1),
    spike(1632),
    spike(1635, 1),
    spike(1639),
    spike(1643, 1),
    spike(1646),
    spike(1650, 1),
    spike(1654),
    spike(1665),
    spike(1672, 1),
    block(1680, 0, 1, 2),
    spike(1687, 1),
    spike(1691),
    spike(1694, 1),
    spike(1698),
    spike(1702, 1),
    spike(1709),
    spike(1713, 1),
    spike(1720),
    spike(1724),
    spike(1728, 1),
    spike(1731),
    spike(1735),
    spike(1739, 1),
    spike(1743),
    spike(1750),
    spike(1757, 1),
    spike(1761),
    spike(1765, 1),
    spike(1772),
    spike(1776, 1),
    spike(1783),
    spike(1787),
    spike(1791, 1),
    spike(1805),
    spike(1809, 1),
    spike(1813),
    spike(1820),
    spike(1824, 1),
    spike(1828),
    spike(1831, 1),
    block(1835, 0, 1, 2),
    spike(1839),
    spike(1850, 1),
    spike(1857),
    spike(1861, 1),
    block(1868, 0, 1, 2),
    spike(1872),
    spike(1876, 1),
    spike(1879),
    spike(1883, 1),
    spike(1887),
    spike(1890, 1),
  ],
  backgroundColor: "#0a1a28",
  accentColor: "#ff00ff",
};

export const LEVELS: LevelData[] = [sampleLevel, level1, level2, level3];

function computeSafeCheckpoints(level: LevelData): number[] {
  const count = PRACTICE_CHECKPOINT_COUNT;
  const checkpoints: number[] = [];

  for (let i = 1; i <= count; i++) {
    const targetX = (level.totalLength * i) / (count + 1);
    const searchRadius = level.totalLength * 0.06;
    let bestX = targetX;
    let bestSafety = -1;

    for (let x = targetX - searchRadius; x <= targetX + searchRadius; x += T) {
      const onGround = level.groundSegments.some(
        (seg) => x >= seg.start + T * 2 && x <= seg.end - T * 2,
      );
      if (!onGround) continue;

      let minDist = Infinity;
      for (const obs of level.obstacles) {
        const dist = Math.abs(x - obs.x);
        if (dist < minDist) minDist = dist;
      }

      const distFromTarget = Math.abs(x - targetX);
      const score = minDist - distFromTarget * 0.3;
      if (score > bestSafety) {
        bestSafety = score;
        bestX = x;
      }
    }

    checkpoints.push(bestX);
  }

  return checkpoints;
}

export const LEVEL_CHECKPOINTS: Map<number, number[]> = new Map(
  LEVELS.map((level) => [level.id, computeSafeCheckpoints(level)]),
);

export function getModeAtPosition(level: LevelData, x: number): GameMode {
  let mode: GameMode = level.startMode;
  for (const portal of level.portals) {
    if (x >= portal.x) {
      mode = portal.targetMode;
    }
  }
  return mode;
}
